!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e=e||self).WebextRedux={})}(this,(function(e){"use strict";function r(e,r){for(var t=0;r.length>t;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function t(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function n(e){for(var r=1;arguments.length>r;r++){var n=null!=arguments[r]?arguments[r]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),o.forEach((function(r){t(e,r,n[r])}))}return e}function o(e){return function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);e.length>r;r++)t[r]=e[r];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var i=9007199254740991,a="[object Arguments]",s="[object Function]",c="[object GeneratorFunction]",u=/^(?:0|[1-9]\d*)$/;function l(e,r,t){switch(t.length){case 0:return e.call(r);case 1:return e.call(r,t[0]);case 2:return e.call(r,t[0],t[1]);case 3:return e.call(r,t[0],t[1],t[2])}return e.apply(r,t)}var f=Object.prototype,d=f.hasOwnProperty,p=f.toString,h=f.propertyIsEnumerable,y=Math.max;function v(e,r){var t=P(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&j(e)}(e)&&d.call(e,"callee")&&(!h.call(e,"callee")||p.call(e)==a)}(e)?function(e,r){for(var t=-1,n=Array(e);++t<e;)n[t]=r(t);return n}(e.length,String):[],n=t.length,o=!!n;for(var i in e)!r&&!d.call(e,i)||o&&("length"==i||b(i,n))||t.push(i);return t}function g(e,r,t){var n=e[r];d.call(e,r)&&w(n,t)&&(void 0!==t||r in e)||(e[r]=t)}function m(e){if(!A(e))return function(e){var r=[];if(null!=e)for(var t in Object(e))r.push(t);return r}(e);var r,t,n=(r=e)===("function"==typeof(t=r&&r.constructor)&&t.prototype||f),o=[];for(var i in e)("constructor"!=i||!n&&d.call(e,i))&&o.push(i);return o}function b(e,r){return!!(r=null==r?i:r)&&("number"==typeof e||u.test(e))&&e>-1&&e%1==0&&r>e}function w(e,r){return e===r||e!=e&&r!=r}var S,E,x,P=Array.isArray;function j(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&i>=e}(e.length)&&!function(e){var r=A(e)?p.call(e):"";return r==s||r==c}(e)}function A(e){var r=typeof e;return!!e&&("object"==r||"function"==r)}var z=(S=function(e,r){!function(e,r,t,n){t||(t={});for(var o=-1,i=r.length;++o<i;){var a=r[o],s=n?n(t[a],e[a],a,t,e):void 0;g(t,a,void 0===s?e[a]:s)}}(r,function(e){return j(e)?v(e,!0):m(e)}(r),e)},E=function(e,r){var t=-1,n=r.length,o=n>1?r[n-1]:void 0,i=n>2?r[2]:void 0;for(o=S.length>3&&"function"==typeof o?(n--,o):void 0,i&&function(e,r,t){if(!A(t))return!1;var n=typeof r;return!!("number"==n?j(t)&&b(r,t.length):"string"==n&&r in t)&&w(t[r],e)}(r[0],r[1],i)&&(o=3>n?void 0:o,n=1),e=Object(e);++t<n;){var a=r[t];a&&S(e,a,t,o)}return e},x=y(void 0===x?E.length-1:x,0),function(){for(var e=arguments,r=-1,t=y(e.length-x,0),n=Array(t);++r<t;)n[r]=e[x+r];r=-1;for(var o=Array(x+1);++r<x;)o[r]=e[r];return o[x]=n,l(E,this,o)}),O="chromex.state",k="chromex.patch_state",M=function(e){return e},N=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M;return n({},e,e.payload?{payload:r(e.payload)}:{})},I=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:M,t=arguments.length>2?arguments[2]:void 0;return t?function(n){for(var o=arguments.length,i=Array(o>1?o-1:0),a=1;o>a;a++)i[a-1]=arguments[a];return t.apply(void 0,[n].concat(i))?e.apply(void 0,[N(n,r)].concat(i)):e.apply(void 0,[n].concat(i))}:function(t){for(var n=arguments.length,o=Array(n>1?n-1:0),i=1;n>i;i++)o[i-1]=arguments[i];return e.apply(void 0,[N(t,r)].concat(o))}},R=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M;return function(r){return function(t,n){return r(I(t,e,n))}}},L=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M;return function(r){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return function(){for(var n=arguments.length,o=Array(n),i=0;n>i;i++)o[i]=arguments[i];if(t>=o.length)throw Error("Message in request could not be serialized. "+"Expected message in position ".concat(t," but only received ").concat(o.length," args."));return o[t]=N(o[t],e),r.apply(void 0,o)}}},_="updated",C="removed";function H(){var e;try{e=self.browser||self.chrome||browser}catch(r){e=browser}if(!e)throw Error("Browser API is not present");return e}var q="\nLooks like there is an error in the background page. You might want to inspect your background page for more details.\n",D={portName:"chromex.port_name",state:{},extensionId:null,serializer:M,deserializer:M,patchStrategy:function(e,r){var t=Object.assign({},e);return r.forEach((function(e){var r=e.key,n=e.value;switch(e.change){case _:t[r]=n;break;case C:Reflect.deleteProperty(t,r)}})),t}};function F(){for(var e=arguments.length,r=Array(e),t=0;e>t;t++)r[t]=arguments[t];return 0===r.length?function(e){return e}:1===r.length?r[0]:r.reduce((function(e,r){return function(){return e(r.apply(void 0,arguments))}}))}var T={portName:"chromex.port_name",dispatchResponder:function(e,r){Promise.resolve(e).then((function(e){r({error:null,value:e})})).catch((function(e){console.error("error dispatching result:",e),r({error:e.message,value:null})}))},serializer:M,deserializer:M,diffStrategy:function(e,r){var t=[];return Object.keys(r).forEach((function(n){e[n]!==r[n]&&t.push({key:n,value:r[n],change:_})})),Object.keys(e).forEach((function(e){r.hasOwnProperty(e)||t.push({key:e,change:C})})),t}};e.Store=function(){function e(){var r=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D,n=t.portName,o=void 0===n?D.portName:n,i=t.state,a=void 0===i?D.state:i,s=t.extensionId,c=void 0===s?D.extensionId:s,u=t.serializer,l=void 0===u?D.serializer:u,f=t.deserializer,d=void 0===f?D.deserializer:f,p=t.patchStrategy,h=void 0===p?D.patchStrategy:p;if(function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),!o)throw Error("portName is required in options");if("function"!=typeof l)throw Error("serializer must be a function");if("function"!=typeof d)throw Error("deserializer must be a function");if("function"!=typeof h)throw Error("patchStrategy must be one of the included patching strategies or a custom patching function");this.portName=o,this.readyResolved=!1,this.readyPromise=new Promise((function(e){return r.readyResolve=e})),this.browserAPI=H(),this.extensionId=c,this.port=this.browserAPI.runtime.connect(this.extensionId,{name:o}),this.safetyHandler=this.safetyHandler.bind(this),this.browserAPI.runtime.onMessage&&(this.safetyMessage=this.browserAPI.runtime.onMessage.addListener(this.safetyHandler)),this.serializedPortListener=R(d)((function(){var e;return(e=r.port.onMessage).addListener.apply(e,arguments)})),this.serializedMessageSender=L(l)((function(){var e;return(e=r.browserAPI.runtime).sendMessage.apply(e,arguments)}),1),this.listeners=[],this.state=a,this.patchStrategy=h,this.serializedPortListener((function(e){switch(e.type){case O:r.replaceState(e.payload),r.readyResolved||(r.readyResolved=!0,r.readyResolve());break;case k:r.patchState(e.payload)}})),this.dispatch=this.dispatch.bind(this)}var t,n,o;return t=e,(n=[{key:"ready",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null!==e?this.readyPromise.then(e):this.readyPromise}},{key:"subscribe",value:function(e){var r=this;return this.listeners.push(e),function(){r.listeners=r.listeners.filter((function(r){return r!==e}))}}},{key:"patchState",value:function(e){this.state=this.patchStrategy(this.state,e),this.listeners.forEach((function(e){return e()}))}},{key:"replaceState",value:function(e){this.state=e,this.listeners.forEach((function(e){return e()}))}},{key:"getState",value:function(){return this.state}},{key:"replaceReducer",value:function(){}},{key:"dispatch",value:function(e){var r=this;return new Promise((function(t,n){window.StyleMedia?r.serializedMessageSender(r.extensionId,{type:"chromex.dispatch",portName:r.portName,payload:e},(function(e){console.log("** resp",e),e||n(z(Error("".concat(q,"some weird error")),"some weird error"));var r=e.error,o=e.value;if(r){var i=Error("".concat(q).concat(r));n(z(i,r))}else t(o&&o.payload)})):r.serializedMessageSender(r.extensionId,{type:"chromex.dispatch",portName:r.portName,payload:e},null,(function(e){console.log("** resp",e),e||n(z(Error("".concat(q,"some weird error")),"some weird error"));var r=e.error,o=e.value;if(r){var i=Error("".concat(q).concat(r));n(z(i,r))}else t(o&&o.payload)}))}))}},{key:"safetyHandler",value:function(e){"storeReady"===e.action&&e.portName===this.portName&&(this.browserAPI.runtime.onMessage.removeListener(this.safetyHandler),this.readyResolved||(this.readyResolved=!0,this.readyResolve()))}}])&&r(t.prototype,n),o&&r(t,o),e}(),e.alias=function(e){return function(){return function(r){return function(t){var n=e[t.type];return r(n?n(t):t)}}}},e.applyMiddleware=function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;r>n;n++)t[n-1]=arguments[n];var i=function(){throw Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},a={getState:e.getState.bind(e),dispatch:function(){return i.apply(void 0,arguments)}};return t=(t||[]).map((function(e){return e(a)})),i=F.apply(void 0,o(t))(e.dispatch),e.dispatch=i,e},e.wrapStore=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:T,t=r.portName,n=void 0===t?T.portName:t,o=r.dispatchResponder,i=void 0===o?T.dispatchResponder:o,a=r.serializer,s=void 0===a?T.serializer:a,c=r.deserializer,u=void 0===c?T.deserializer:c,l=r.diffStrategy,f=void 0===l?T.diffStrategy:l;if(!n)throw Error("portName is required in options");if("function"!=typeof s)throw Error("serializer must be a function");if("function"!=typeof u)throw Error("deserializer must be a function");if("function"!=typeof f)throw Error("diffStrategy must be one of the included diffing strategies or a custom diff function");var d=H(),p=function(r,t,o){if("chromex.dispatch"===r.type&&r.portName===n){var a=Object.assign({},r.payload,{_sender:t}),s=null;try{s=e.dispatch(a)}catch(e){s=Promise.reject(e.message),console.error(e)}return i(s,o),!0}},h=function(r){if(r.name===n){var t=L(s)((function(){return r.postMessage.apply(r,arguments)})),o=e.getState(),i=e.subscribe((function(){var r=e.getState(),n=f(o,r);n.length&&(o=r,t({type:k,payload:n}))}));r.onDisconnect.addListener(i),t({type:O,payload:o})}},y=R(u),v=function(e){return"chromex.dispatch"===e.type&&e.portName===n};y((function(){var e;return(e=d.runtime.onMessage).addListener.apply(e,arguments)}))(p,v),d.runtime.onMessageExternal?y((function(){var e;return(e=d.runtime.onMessageExternal).addListener.apply(e,arguments)}))(p,v):console.warn("runtime.onMessageExternal is not supported"),d.runtime.onConnect.addListener(h),d.runtime.onConnectExternal?d.runtime.onConnectExternal.addListener(h):console.warn("runtime.onConnectExternal is not supported"),d.tabs.query({},(function(e){var r=!0,t=!1,o=void 0;try{for(var i,a=e[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){d.tabs.sendMessage(i.value.id,{action:"storeReady",portName:n},(function(){chrome}))}}catch(e){t=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(t)throw o}}}))},Object.defineProperty(e,"__esModule",{value:!0})}));
